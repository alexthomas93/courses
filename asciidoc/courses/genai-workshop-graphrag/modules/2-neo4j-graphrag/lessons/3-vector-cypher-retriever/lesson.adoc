= VectorCypherRetriever
:order: 3
:type: challenge
:sandbox: true

== Understanding VectorCypherRetriever

The `VectorCypherRetriever` combines vector similarity with Cypher queries to retrieve relevant nodes from your Neo4j recommendations database. This integration allows for more refined searches by applying graph-specific filters alongside semantic similarity.


=== How It Works
image:images/vector-cypher-retrieval.png[VectorCypherRetriever,width=800,align=center]

* **Cypher Filtering**: Applies a Cypher query to filter nodes based on specific criteria.

== When to Use VectorCypherRetriever

* **Combined Filtering and Similarity**: When you need to filter nodes based on properties or relationships before performing a similarity search.
* **Structured and Unstructured Data**: Your graph contains both structured properties and unstructured text data.
* **Advanced Querying**: Require complex retrieval logic that leverages Cypherâ€™s capabilities alongside vector similarity.

== Setting Up VectorCypherRetriever

Follow these steps to set up and use the `VectorCypherRetriever`.

=== Step 1: Install Required Libraries

Install the necessary Python packages:

[source, bash]
----
pip install neo4j-graphrag neo4j openai
----

=== Step 2: Connect to Your Neo4j Database

Establish a connection using the Neo4j Python driver:

[source, python]

----
include::{repository-raw}/main/2-neo4j-graphrag/solutions/vector_cypher_retriever.py[tag=setup]

----

=== Step 3: Set Up the Embedding Function

Define a function to generate query embeddings using OpenAI's model:

[source, python]
----
include::{repository-raw}/main/2-neo4j-graphrag/solutions/vector_cypher_retriever.py[tag=embedder]
----

=== Step 4: Initialize the VectorCypherRetriever

Create an instance of `VectorCypherRetriever` with a Cypher query:

[source, python]
----
include::{repository-raw}/main/2-neo4j-graphrag/solutions/vector_cypher_retriever.py[tag=retriever]
----
* `driver`: Neo4j database driver.
* `embedding_function`: Function to generate query embeddings.
* `vector_property`: Property storing node embeddings.
* `top_k`: Number of top similar nodes to retrieve.
* `cypher_query`: Cypher statement to filter nodes before similarity search.

== Example in Action

Assume you have a recommendations database with movies, each having an `embedding` property and a `genre` attribute.

=== Running the Retriever

Given a query, `VectorCypherRetriever` finds semantically similar thriller movies with strong female leads:

[source, python]
----
include::{repository-raw}/main/2-neo4j-graphrag/solutions/vector_cypher_retriever.py[tag=graphrag]
----
=== Expected Output

----
The actors in the movie "Jumanji," which is about a magical board game, are Robin Williams, Bradley Pierce, Kirsten Dunst, and Jonathan Hyde.
----

== Tips for Effective Use

* **Consistent Embeddings**: Use the same model for query and node embeddings.
* **Vector Indexing**: Create a vector index in Neo4j on the `embedding` property to speed up searches.
* **Optimize Cypher Queries**: Ensure your Cypher queries are efficient to reduce retrieval time.

== Next Steps

In the next lesson, you'll learn how to build a GraphRAG pipeline using the `VectorCypherRetriever`.

read::Continue to Building a GraphRAG Pipeline[]

[.summary]
== Summary

You've learned how to use `VectorCypherRetriever` to perform filtered semantic searches in Neo4j, enhancing your RAG pipeline by combining Cypher queries with vector similarity.
