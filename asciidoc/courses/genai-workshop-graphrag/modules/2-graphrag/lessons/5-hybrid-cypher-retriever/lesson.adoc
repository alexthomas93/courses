= HybridCypherRetriever
:order: 5
:type: challenge
:sandbox: true

== Understanding HybridCypherRetriever

The `HybridCypherRetriever` enhances the retrieval process by combining hybrid search (vector and full-text) with graph traversal techniques. This allows you to retrieve not only semantically similar nodes but also related information through graph relationships, enabling more comprehensive and accurate responses in your GraphRAG applications.

=== How It Works

* **Hybrid Search**: Combines vector similarity and full-text search to find relevant nodes.
* **Graph Traversal**: Uses Cypher queries to fetch additional related nodes based on the initial retrieval.
* **Aggregation**: Merges results from both search methods and traversal to provide enriched data for the language model.

== When to Use HybridCypherRetriever

* **Complex Queries**: When user queries require both semantic understanding and specific relationship-based information.
* **Rich Data Relationships**: Your graph contains interconnected data where related nodes hold valuable context.
* **Enhanced Accuracy**: Aim to retrieve precise information by leveraging both search methods and graph structure.

== Setting Up HybridCypherRetriever

Follow these steps to set up and use the `HybridCypherRetriever`.

=== Step 1: Install Required Libraries

Install the necessary Python packages:

[source, bash]
----
pip install neo4j-graphrag neo4j openai
----

=== Step 2: Connect to Your Neo4j Database

Establish a connection using the Neo4j Python driver:

[source, python]
----
from neo4j import GraphDatabase

# Demo database credentials
URI = "neo4j+s://demo.neo4jlabs.com"
AUTH = ("recommendations", "recommendations")

# Connect to Neo4j database
driver = GraphDatabase.driver(URI, auth=AUTH)
----

Placeholder for Image: Neo4j Connection Diagram

=== Step 3: Set Up the Embedding Function

Define a function to generate query embeddings using OpenAI's model:

[source, python]
----
import os
from neo4j_graphrag.embeddings.openai import OpenAIEmbeddings

os.environ["OPENAI_API_KEY"] = "sk-â€¦"
embedder = OpenAIEmbeddings(model="text-embedding-ada-002")
----

=== Step 4: Initialize the HybridCypherRetriever

Create an instance of `HybridCypherRetriever` with hybrid search and graph traversal:

[source, python]
----
from neo4j_graphrag import HybridCypherRetriever

retrieval_query = """
MATCH (actor:Actor)-[:ACTED_IN]->(movie:Movie)
RETURN movie.title AS movie_title,
       movie.plot AS movie_plot,
       collect(actor.name) AS actors;
"""

retriever = HybridCypherRetriever(
    driver=driver,
    vector_index_name="moviePlotsEmbedding",
    fulltext_index_name="movieFulltext",
    retrieval_query=retrieval_query,
    embedder=embedder,
)
----
* `driver`: Neo4j database driver.
* `vector_index_name`: Name of the vector index for semantic search.
* `fulltext_index_name`: Name of the full-text index for keyword search.
* `retrieval_query`: Cypher query to fetch related nodes.
* `embedder`: Function to generate query embeddings.


== Example in Action

Assume you have a recommendations database with movies, each having an `embedding` property and a `genre` attribute.

=== Running the Retriever

Given a query, `HybridCypherRetriever` finds semantically similar thriller movies with strong female leads:

[source, python]
----
from neo4j_graphrag.generation import GraphRAG

llm = OpenAILLM(model_name="gpt-4o", model_params={"temperature": 0})
rag = GraphRAG(retriever=retriever, llm=llm)
query_text = "What are the names of the actors in the movie set in 1375 in Imperial China?"
response = rag.search(query_text=query_text, retriever_config={"top_k": 5})
print(response.answer)
----
=== Expected Output

----
The names of the actors in the movie set in 1375 in Imperial China, "Musa the Warrior (Musa)," are Irrfan Khan, Ziyi Zhang, Sung-kee Ahn, and Jin-mo Ju.
----

== Tips for Effective Use

* **Consistent Embeddings**: Use the same model for query and node embeddings.
* **Vector Indexing**: Create a vector index in Neo4j on the `embedding` property to speed up searches.
* **Optimize Queries**: Ensure your Cypher and full-text queries are efficient to reduce retrieval time.
* **Leverage Graph Relationships**: Design your graph schema to maximize the benefits of traversal-based retrieval.

== Next Steps

In the next lesson, you'll learn how to build a GraphRAG pipeline using the `HybridCypherRetriever`.

read::Continue to Building a GraphRAG Pipeline[]

[.summary]
== Summary

You've learned how to use `HybridCypherRetriever` to perform advanced filtered semantic searches in Neo4j, enhancing your RAG pipeline by combining hybrid search methods with graph traversal techniques. This enables your applications to handle more complex queries and retrieve comprehensive information.